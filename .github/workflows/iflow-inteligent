name: "ðŸ§  iflow intelijen"

on:
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  gather_data:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch GitHub Actions run history
        run: |
          mkdir -p intel
          gh run list --limit 100 --json run_number,workflow_name,conclusion,run_duration_ms,created_at > intel/gha_runs.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch recent open issues
        run: |
          gh issue list --state open --limit 200 --json number,title,labels,createdAt,updatedAt > intel/open_issues.json

      - name: Fetch recent PR history
        run: |
          gh pr list --state all --limit 200 --json number,title,merged,createdAt,closedAt,author > intel/recent_prs.json

      - name: Upload collected data
        uses: actions/upload-artifact@v3
        with:
          name: repo-intel-data-${{ github.run_id }}
          path: intel/

  analyse_and_create_issues:
    needs: gather_data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download data artifacts
        uses: actions/download-artifact@v3
        with:
          name: repo-intel-data-${{ github.run_id }}
          path: ./intel

      - name: Run iFlow CLI Agent for analysis and auto-issue creation
        uses: iflow-ai/iflow-cli-action@v2.1.0
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: "7200"
          prompt: |
            ## ROLE  
            You are an autonomous GitHub repository intelligence agent with write-access.  

            ## CONTEXT  
            - Repository: ${{ github.repository }}  
            - CI/CD runs data: ./intel/gha_runs.json  
            - Open issues data: ./intel/open_issues.json  
            - PR history data: ./intel/recent_prs.json  
            - Full repository code base is checked-out and available for deep analysis  

            ## TASKS  
            1. Deeply analyze the codebase: modules, dependencies, documentation, test coverage gaps, duplication, naming inconsistencies.  
            2. Analyze CI/CD logs: identify jobs with frequent failures, long durations (>10 minutes), reruns, unstable workflows.  
            3. Analyze issue/PR history: stale issues (open >60 days), PRs closed without merge, recurring bug patterns.  
            4. Generate findings:  
               - Bugs/inefficiencies (with description, location, impact)  
               - Improvement opportunities (with gap and suggestion)  
               - Feature ideas (at least two) with value proposition, rough implementation steps, estimated effort/impact  
            5. For each finding: decide whether to **create a GitHub Issue** immediately.  
               - If yes â†’ use `gh issue create --title "...â€œ --body "...â€œ --label "kind/bug,priority/high"` or appropriate labels:  
                 * Category: `kind/bug`, `kind/enhancement`, `kind/documentation`, `kind/architecture`  
                 * Priority: `priority/critical`, `priority/high`, `priority/medium`, `priority/low`  
            6. For improvement requiring workflow/config change: output unified-diff snippet targeting `.github/workflows/` or config files and commit or open PR if safe.  
            7. Self-improvement plan: based on this run (or expected if first) propose what additional data will be collected next time, which thresholds to adjust, how prompt or logic will be refined.  

            ## RULES  
            - Do not expose or log any secrets.  
            - All code changes (issue creation, patches) must be small, atomic, maintainable.  
            - When creating issues: ensure labels exist or create them before using.  
            - When suggesting patches: only modify workflow/config files, show unified-diff format.  
            - Use `gh issue create` or `gh pr create` commands within the agent to perform creations.  
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

