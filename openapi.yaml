openapi: 3.0.3
info:
  title: Akademia Pro API
  description: |
    School management system API for students, teachers, parents, and administrators.
    
    ## Authentication
    
    Most endpoints require authentication via JWT token. Include the token in the `Authorization` header:
    
    ```
    Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
    ```
    
    Tokens are obtained via the `/api/auth/login` endpoint and expire after 24 hours.
    
    ## Rate Limiting
    
    All endpoints are rate-limited. Check the response headers for rate limit information:
    
    - `X-RateLimit-Limit`: Maximum requests per window
    - `X-RateLimit-Remaining`: Remaining requests in current window
    - `X-RateLimit-Reset`: Unix timestamp when window resets
    
    ## Error Handling
    
    All errors follow a standard format:
    
    ```json
    {
      "success": false,
      "error": "Error message",
      "code": "ERROR_CODE",
      "requestId": "uuid-v4",
      "details": {}
    }
    ```
    
    See the error codes section for a complete list of possible error codes.
  version: 1.0.0
  contact:
    name: Akademia Pro Support
    email: support@akademiapro.com
  license:
    name: Proprietary

servers:
  - url: https://your-domain.workers.dev/api
    description: Production server
  - url: https://staging.your-domain.workers.dev/api
    description: Staging server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: User authentication and token management
  - name: Students
    description: Student portal endpoints
  - name: Teachers
    description: Teacher portal endpoints
  - name: Parents
    description: Parent portal endpoints
  - name: Admin
    description: Admin portal endpoints
  - name: Webhooks
    description: Webhook configuration and management
  - name: Monitoring
    description: System monitoring and metrics

paths:
  /health:
    get:
      tags:
        - Health
      summary: Check API health
      description: Returns current health status of API
      operationId: healthCheck
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /seed:
    post:
      tags:
        - Admin
      summary: Seed database
      description: Seeds database with sample data for development/testing
      operationId: seedDatabase
      responses:
        '200':
          description: Database seeded successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string
                          recordsCreated:
                            type: integer
        '400':
          description: Database already seeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: Authenticates a user and returns a JWT token
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/verify:
    get:
      tags:
        - Authentication
      summary: Verify token
      description: Verifies a JWT token and returns user information
      operationId: verifyToken
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '401':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /students/{id}/dashboard:
    get:
      tags:
        - Students
      summary: Get student dashboard
      description: Retrieves student dashboard data including schedule, grades, and announcements
      operationId: getStudentDashboard
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Student ID
          schema:
            type: string
      responses:
        '200':
          description: Dashboard data retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/StudentDashboard'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Student not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /students/{id}/grades:
    get:
      tags:
        - Students
      summary: Get student grades
      description: Retrieves all grades for a specific student
      operationId: getStudentGrades
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Student ID
          schema:
            type: string
      responses:
        '200':
          description: Grades retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Grade'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Student not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /students/{id}/schedule:
    get:
      tags:
        - Students
      summary: Get student schedule
      description: Retrieves schedule for a specific student
      operationId: getStudentSchedule
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Student ID
          schema:
            type: string
      responses:
        '200':
          description: Schedule retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/ScheduleItem'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Student or class not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /students/{id}/card:
    get:
      tags:
        - Students
      summary: Get student card
      description: Retrieves student card with grades distribution and recent grades
      operationId: getStudentCard
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Student ID
          schema:
            type: string
      responses:
        '200':
          description: Student card retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/StudentCardData'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Student not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /parents/{id}/dashboard:
    get:
      tags:
        - Parents
      summary: Get parent dashboard
      description: Retrieves parent dashboard data including child data
      operationId: getParentDashboard
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Parent ID
          schema:
            type: string
      responses:
        '200':
          description: Dashboard data retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ParentDashboard'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Parent or child not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /teachers/{id}/dashboard:
    get:
      tags:
        - Teachers
      summary: Get teacher dashboard
      description: Retrieves teacher dashboard data with class information and metrics
      operationId: getTeacherDashboard
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Teacher ID
          schema:
            type: string
      responses:
        '200':
          description: Dashboard data retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          classes:
                            type: array
                            items:
                              $ref: '#/components/schemas/Class'
                          totalStudents:
                            type: integer
                          recentGrades:
                            type: array
                            items:
                              $ref: '#/components/schemas/Grade'
                          recentAnnouncements:
                            type: array
                            items:
                              $ref: '#/components/schemas/Announcement'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Teacher not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /teachers/{id}/announcements:
    get:
      tags:
        - Teachers
      summary: Get teacher announcements
      description: Retrieves announcements created by a specific teacher
      operationId: getTeacherAnnouncements
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Teacher ID
          schema:
            type: string
      responses:
        '200':
          description: Announcements retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Announcement'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /teachers/announcements:
    post:
      tags:
        - Teachers
      summary: Create announcement
      description: Creates a new announcement
      operationId: createTeacherAnnouncement
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - content
                - targetRole
              properties:
                title:
                  type: string
                  description: Announcement title
                content:
                  type: string
                  description: Announcement content
                targetRole:
                  type: string
                  enum: [student, teacher, parent, all]
                  description: Target role for announcement
      responses:
        '200':
          description: Announcement created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Announcement'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /teachers/{id}/classes:
    get:
      tags:
        - Teachers
      summary: Get teacher classes
      description: Retrieves all classes taught by a teacher
      operationId: getTeacherClasses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Teacher ID
          schema:
            type: string
      responses:
        '200':
          description: Classes retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Class'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /classes/{id}/students:
    get:
      tags:
        - Teachers
      summary: Get class students
      description: Retrieves all students in a class with their grades
      operationId: getClassStudents
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Class ID
          schema:
            type: string
      responses:
        '200':
          description: Students retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/StudentWithGrade'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Class not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /grades:
    post:
      tags:
        - Teachers
      summary: Create grade
      description: Creates a new grade for a student
      operationId: createGrade
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGradeRequest'
      responses:
        '200':
          description: Grade created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Grade'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /grades/{id}:
    put:
      tags:
        - Teachers
      summary: Update grade
      description: Updates an existing grade
      operationId: updateGrade
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Grade ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateGradeRequest'
      responses:
        '200':
          description: Grade updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Grade'
        '400':
          description: Grade not created yet
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Grade not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users:
    get:
      tags:
        - Admin
      summary: Get all users
      description: Retrieves all users with optional filtering
      operationId: getUsers
      security:
        - BearerAuth: []
      parameters:
        - name: role
          in: query
          description: Filter by role
          schema:
            type: string
            enum: [student, teacher, parent, admin]
        - name: classId
          in: query
          description: Filter by class ID (for students)
          schema:
            type: string
        - name: teacherId
          in: query
          description: Filter by teacher ID (for classes)
          schema:
            type: string
      responses:
        '200':
          description: Users retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Admin
      summary: Create user
      description: Creates a new user account
      operationId: createUser
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CreateStudentRequest'
                - $ref: '#/components/schemas/CreateTeacherRequest'
                - $ref: '#/components/schemas/CreateParentRequest'
                - $ref: '#/components/schemas/CreateAdminRequest'
      responses:
        '200':
          description: User created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{id}:
    get:
      tags:
        - Admin
      summary: Get user
      description: Retrieves a specific user by ID
      operationId: getUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: User ID
          schema:
            type: string
      responses:
        '200':
          description: User retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Admin
      summary: Update user
      description: Updates an existing user account
      operationId: updateUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: User ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Admin
      summary: Delete user
      description: Deletes a user account
      operationId: deleteUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: User ID
          schema:
            type: string
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DeleteUserResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/dashboard:
    get:
      tags:
        - Admin
      summary: Get admin dashboard
      description: Retrieves admin dashboard data with user distribution and system metrics
      operationId: getAdminDashboard
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Dashboard data retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          totalStudents:
                            type: integer
                          totalTeachers:
                            type: integer
                          totalParents:
                            type: integer
                          totalAdmins:
                            type: integer
                          recentAnnouncements:
                            type: array
                            items:
                              $ref: '#/components/schemas/Announcement'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/users:
    get:
      tags:
        - Admin
      summary: Get users with filters
      description: Retrieves users with optional role and class filters
      operationId: getAdminUsers
      security:
        - BearerAuth: []
      parameters:
        - name: role
          in: query
          description: Filter by role
          schema:
            type: string
            enum: [student, teacher, parent, admin]
        - name: classId
          in: query
          description: Filter by class ID (for students)
          schema:
            type: string
        - name: search
          in: query
          description: Search by name or email
          schema:
            type: string
      responses:
        '200':
          description: Users retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/announcements:
    get:
      tags:
        - Admin
      summary: Get announcements
      description: Retrieves all announcements
      operationId: getAnnouncements
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Announcements retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Announcement'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Admin
      summary: Create announcement
      description: Creates a new announcement
      operationId: createAdminAnnouncement
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - content
                - targetRole
              properties:
                title:
                  type: string
                  description: Announcement title
                content:
                  type: string
                  description: Announcement content
                targetRole:
                  type: string
                  enum: [student, teacher, parent, all]
                  description: Target role for announcement
      responses:
        '200':
          description: Announcement created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Announcement'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/settings:
    get:
      tags:
        - Admin
      summary: Get system settings
      description: Retrieves system configuration settings
      operationId: getSettings
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Settings retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          allowPublicRegistration:
                            type: boolean
                          maintenanceMode:
                            type: boolean
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Admin
      summary: Update system settings
      description: Updates system configuration settings
      operationId: updateSettings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                allowPublicRegistration:
                  type: boolean
                maintenanceMode:
                  type: boolean
      responses:
        '200':
          description: Settings updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          allowPublicRegistration:
                            type: boolean
                          maintenanceMode:
                            type: boolean
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/rebuild-indexes:
    post:
      tags:
        - Admin
      summary: Rebuild indexes
      description: Rebuilds all secondary indexes from existing data
      operationId: rebuildIndexes
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Indexes rebuilt successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          status:
                            type: string
                          indexesRebuilt:
                            type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks:
    get:
      tags:
        - Webhooks
      summary: List webhooks
      description: Retrieves all webhook configurations
      operationId: listWebhooks
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Webhooks retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/WebhookConfig'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Webhooks
      summary: Create webhook
      description: Creates a new webhook configuration
      operationId: createWebhook
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebhookRequest'
      responses:
        '200':
          description: Webhook created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/WebhookConfig'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/{id}:
    get:
      tags:
        - Webhooks
      summary: Get webhook
      description: Retrieves a specific webhook configuration
      operationId: getWebhook
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Webhook configuration ID
          schema:
            type: string
      responses:
        '200':
          description: Webhook retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/WebhookConfig'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Webhook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Webhooks
      summary: Update webhook
      description: Updates an existing webhook configuration
      operationId: updateWebhook
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Webhook configuration ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWebhookRequest'
      responses:
        '200':
          description: Webhook updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/WebhookConfig'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Webhook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Webhooks
      summary: Delete webhook
      description: Deletes a webhook configuration
      operationId: deleteWebhook
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Webhook configuration ID
          schema:
            type: string
      responses:
        '200':
          description: Webhook deleted successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id:
                            type: string
                          deleted:
                            type: boolean
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Webhook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/test:
    post:
      tags:
        - Webhooks
      summary: Test webhook
      description: Sends a test payload to a webhook URL
      operationId: testWebhook
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestWebhookRequest'
      responses:
        '200':
          description: Test webhook sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  status:
                    type: integer
                    description: HTTP status code from webhook endpoint
                  response:
                    type: string
                  error:
                    type: string
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/webhooks/process:
    post:
      tags:
        - Monitoring
      summary: Process webhook deliveries
      description: Manually processes pending webhook deliveries
      operationId: processWebhookDeliveries
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Webhook deliveries processed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string

  /admin/webhooks/dead-letter-queue:
    get:
      tags:
        - Monitoring
      summary: Get dead letter queue
      description: Retrieves all failed webhook deliveries
      operationId: getDeadLetterQueue
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Dead letter queue retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/DeadLetterWebhook'

  /admin/webhooks/dead-letter-queue/{id}:
    delete:
      tags:
        - Monitoring
      summary: Delete dead letter queue entry
      description: Deletes an entry from the dead letter queue
      operationId: deleteDeadLetterEntry
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Dead letter queue entry ID
          schema:
            type: string
      responses:
        '200':
          description: Entry deleted successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id:
                            type: string
                          deleted:
                            type: boolean

  /admin/metrics:
    get:
      tags:
        - Monitoring
      summary: Get system metrics
      description: Retrieves integration monitoring metrics
      operationId: getMetrics
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Metrics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Metrics'

  /admin/rate-limit:
    get:
      tags:
        - Monitoring
      summary: Get rate limit stats
      description: Retrieves rate limiting statistics
      operationId: getRateLimitStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Rate limit stats retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/RateLimitStats'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT authentication token obtained from /api/auth/login

  schemas:
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        requestId:
          type: string
          format: uuid

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Error code
          enum:
            - NETWORK_ERROR
            - TIMEOUT
            - RATE_LIMIT_EXCEEDED
            - SERVICE_UNAVAILABLE
            - CIRCUIT_BREAKER_OPEN
            - UNAUTHORIZED
            - FORBIDDEN
            - NOT_FOUND
            - VALIDATION_ERROR
            - CONFLICT
            - BAD_REQUEST
            - INTERNAL_SERVER_ERROR
        requestId:
          type: string
          format: uuid
        details:
          type: object
          description: Additional error details
          additionalProperties: true

    HealthResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                status:
                  type: string
                  example: healthy
                timestamp:
                  type: string
                  format: date-time

    LoginRequest:
      type: object
      required:
        - email
        - password
        - role
      properties:
        email:
          type: string
          format: email
          description: User's email address
        password:
          type: string
          format: password
          description: User's password
        role:
          type: string
          enum: [student, teacher, parent, admin]
          description: User's role

    LoginResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                token:
                  type: string
                  description: JWT authentication token
                user:
                  $ref: '#/components/schemas/User'

    User:
      type: object
      properties:
        id:
          type: string
          description: User ID
        name:
          type: string
          description: User's full name
        email:
          type: string
          format: email
          description: User's email address
        role:
          type: string
          enum: [student, teacher, parent, admin]
          description: User's role
        avatarUrl:
          type: string
          format: uri
          description: URL to user's avatar image
        classId:
          type: string
          description: Class ID (for students)
        studentIdNumber:
          type: string
          description: Student ID number
        classIds:
          type: array
          items:
            type: string
          description: List of class IDs (for teachers)
        childId:
          type: string
          description: Child's user ID (for parents)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    StudentDashboard:
      type: object
      properties:
        schedule:
          type: array
          items:
            type: object
            properties:
              day:
                type: string
                enum: [Senin, Selasa, Rabu, Kamis, Jumat]
              time:
                type: string
                example: "08:00 - 09:30"
              courseId:
                type: string
              courseName:
                type: string
              teacherName:
                type: string
        recentGrades:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/Grade'
              - type: object
                properties:
                  courseName:
                    type: string
        announcements:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/Announcement'
              - type: object
                properties:
                  authorName:
                    type: string

    Class:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
          example: "11-A"
        teacherId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    StudentWithGrade:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        score:
          type: number
        feedback:
          type: string
        gradeId:
          type: string

    Grade:
      type: object
      properties:
        id:
          type: string
        studentId:
          type: string
        courseId:
          type: string
        score:
          type: number
          minimum: 0
          maximum: 100
        feedback:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateGradeRequest:
      type: object
      required:
        - studentId
        - courseId
        - score
        - feedback
      properties:
        studentId:
          type: string
        courseId:
          type: string
        score:
          type: number
          minimum: 0
          maximum: 100
        feedback:
          type: string

    UpdateGradeRequest:
      type: object
      required:
        - score
        - feedback
      properties:
        score:
          type: number
          minimum: 0
          maximum: 100
        feedback:
          type: string

    CreateStudentRequest:
      type: object
      required:
        - name
        - email
        - role
        - classId
        - studentIdNumber
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [student]
        classId:
          type: string
        studentIdNumber:
          type: string
        password:
          type: string
          format: password
          description: Optional password (if not provided, will be generated)

    CreateTeacherRequest:
      type: object
      required:
        - name
        - email
        - role
        - classIds
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [teacher]
        classIds:
          type: array
          items:
            type: string
        password:
          type: string
          format: password
          description: Optional password (if not provided, will be generated)

    CreateParentRequest:
      type: object
      required:
        - name
        - email
        - role
        - childId
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [parent]
        childId:
          type: string
        password:
          type: string
          format: password
          description: Optional password (if not provided, will be generated)

    CreateAdminRequest:
      type: object
      required:
        - name
        - email
        - role
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [admin]
        password:
          type: string
          format: password
          description: Optional password (if not provided, will be generated)

    UpdateUserRequest:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        classId:
          type: string
        studentIdNumber:
          type: string
        classIds:
          type: array
          items:
            type: string
        childId:
          type: string

    DeleteUserResponse:
      type: object
      properties:
        id:
          type: string
        deleted:
          type: boolean
        warnings:
          type: array
          items:
            type: string
          description: Warnings if deletion was not complete

    Announcement:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        content:
          type: string
        date:
          type: string
          format: date-time
        authorId:
          type: string
        targetRole:
          type: string
          enum: [student, teacher, parent, admin, all]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    WebhookConfig:
      type: object
      properties:
        id:
          type: string
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
            enum:
              - grade.created
              - grade.updated
              - user.created
              - user.updated
              - user.deleted
              - announcement.created
              - announcement.updated
        secret:
          type: string
        active:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateWebhookRequest:
      type: object
      required:
        - url
        - events
        - secret
      properties:
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
        secret:
          type: string
        active:
          type: boolean
          default: true

    UpdateWebhookRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
        secret:
          type: string
        active:
          type: boolean

    TestWebhookRequest:
      type: object
      required:
        - url
        - secret
      properties:
        url:
          type: string
          format: uri
        secret:
          type: string

    DeadLetterWebhook:
      type: object
      properties:
        id:
          type: string
        eventId:
          type: string
        webhookConfigId:
          type: string
        eventType:
          type: string
        url:
          type: string
          format: uri
        payload:
          type: object
        status:
          type: integer
        attempts:
          type: integer
        errorMessage:
          type: string
        failedAt:
          type: string
          format: date-time

    Metrics:
      type: object
      properties:
        requests:
          type: object
          properties:
            total:
              type: integer
            errors:
              type: integer
            errorRate:
              type: number
            avgResponseTime:
              type: number
        circuitBreakers:
          type: object
          properties:
            open:
              type: integer
            closed:
              type: integer
            halfOpen:
              type: integer
        webhooks:
          type: object
          properties:
            total:
              type: integer
            successful:
              type: integer
            failed:
              type: integer
            pending:
              type: integer

    RateLimitStats:
      type: object
      properties:
        totalRequests:
          type: integer
        blockedRequests:
          type: integer
        blockRate:
          type: number
        activeEntries:
          type: integer
